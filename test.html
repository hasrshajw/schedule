<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunday Schedule Editor</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
    :root {
        --header-bg: #292929;
        --text-light: #fff;
        --body-bg: #f8fafc;
        --menu-new-text: #4a6da7;
        --menu-new-bg: #ffffff;
        --menu-new-border: #eeeeee;
        --menu-new-hover: #f5f5f5;
        --primary-color: #012726;
        --primary-hover: #024443;
        --primary-light: #e6f6f6;
        --danger-color: #d32f2f;
        --danger-hover: #b71c1c;
        --border-color: #e5e7eb;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --surface-color: #ffffff;
        --radius-md: 8px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --warning-color: #f59e0b;
        --success-color: #2e7d32;
        --accent-color: #3182ce;
    }

    @font-face {
        font-family: "jw-icons-external";
        src: url("./jw-icons-external-d876da3.woff") format("woff");
        font-weight: normal; font-style: normal;
    }

    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Inter', 'Noto Sans Telugu', sans-serif; background-color: var(--body-bg); color: var(--text-primary); line-height: 1.5; visibility: hidden; opacity: 0; transition: opacity 0.3s ease-in; }
    body.auth-ready { visibility: visible; opacity: 1; }
    body.menu-open { overflow: hidden; }
    body.dropdown-open { overflow: hidden; }

    .site-header { background-color: var(--header-bg); padding: 0; color: var(--text-light); position: fixed; top: 0; left: 0; width: 100%; z-index: 900; box-shadow: var(--shadow-md); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; height: 56px; padding: 0 15px 0 0; max-width: 1200px; margin: 0 auto; }
    .top-bar .mobileLogo { display: block; width: 75px; height: 56px; background-image: url(https://www.jw.org/assets/ct/46605f23da/images/siteLogo-jworg-mobile.svg), none; background-repeat: no-repeat; background-size: contain; background-position: center left; flex-shrink: 0; }
    .header-right-controls { display: flex; align-items: center; gap: 15px; }
    .header-icons { display: flex; align-items: center; justify-content: center; height: 56px; width: 56px; }
    
    .hamburger { cursor: pointer; display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }
    .hamburger input { display: none; }
    .hamburger svg { height: 2em; transition: transform 600ms cubic-bezier(0.4, 0, 0.2, 1); }
    .line { fill: none; stroke: white; stroke-linecap: round; stroke-linejoin: round; stroke-width: 3; transition: stroke-dasharray 600ms cubic-bezier(0.4, 0, 0.2, 1), stroke-dashoffset 600ms cubic-bezier(0.4, 0, 0.2, 1); }
    .line-top-bottom { stroke-dasharray: 12 63; }
    .hamburger input:checked + svg { transform: rotate(-45deg); }
    .hamburger input:checked + svg .line-top-bottom { stroke-dasharray: 20 300; stroke-dashoffset: -32.42; }
    
    .menu-overlay { position: fixed; top: 56px; left: 0; width: 100%; height: calc(100% - 56px); background-color: rgba(0, 0, 0, 0.6); z-index: 998; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; backdrop-filter: blur(2px); }
    .menu-overlay.is-open { opacity: 1; visibility: visible; }
    .slide-menu { position: fixed; top: 56px; right: 0; height: calc(100dvh - 56px); width: 320px; max-width: 90%; background-color: var(--menu-new-bg); z-index: 999; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; border-left: 1px solid var(--menu-new-border); box-shadow: var(--shadow-lg); }
    .slide-menu.is-open { transform: translateX(0); }
    .menu-links { list-style: none; margin: 0; padding: 0; overflow-y: auto; flex-grow: 1; }
    .menu-links li a { display: flex; align-items: center; color: var(--menu-new-text); background-color: var(--menu-new-bg); height: 50px; padding: 12px 5px 12px 12px; box-sizing: border-box; text-decoration: none; font-size: 1rem; transition: background-color 0.2s; border-top: 1px dotted #a7a7a7; }
    .menu-links li:first-child a { border-top: none; }
    .menu-links li a:hover { background-color: var(--menu-new-hover); }
    .profile-section { padding: 16px; border-top: 1px solid var(--menu-new-border); flex-shrink: 0; background-color: #fafafa; margin-top: auto; }
    .profile-info { display: flex; align-items: center; }
    .profile-name { font-weight: bold; font-size: 1rem; color: #333; word-break: break-all; }
    .iconLink-icon { font-family: "jw-icons-external"; font-size: 24px; display: inline-block; color: #757575; width: 30px; margin-right: 10px; text-align: center; transition: color 0.2s; }
    .menu-links li a:hover .iconLink-icon { color: var(--menu-new-text); }
    .home-icon::before { content: "\e661"; }
    .midweek-icon::before { content: "\e625"; }
    .sunday-icon::before { content: "\e610"; }
    .members-icon::before { content: "\e695"; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: var(--radius-md); font-size: 1rem; font-weight: 600; cursor: pointer; border: none; text-decoration: none; background-color: var(--primary-color); color: white; transition: all 0.2s ease; box-shadow: var(--shadow-sm); }
    .btn:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn:active:not(:disabled) { transform: translateY(0); }
    .btn:disabled { cursor: not-allowed; opacity: 0.6; }

    .hidden { display: none !important; }
    main { padding: calc(56px + 20px) 20px 20px; min-height: 100vh; }
    .editor-main { max-width: 1100px; margin: 0 auto; }
    .page-controls { margin-bottom: 24px; display: flex; justify-content: flex-end; align-items: center; gap: 12px; }
    .master-container { background: var(--surface-color); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
    .schedule-display-header { text-align: center; margin-bottom: 24px; }
    .title-block h1 { margin: 0 0 12px 0; font-size: 1.8em; font-weight: 700; color: rgb(97, 40, 0); font-family: 'Noto Sans Telugu', sans-serif; line-height: 1.3; }
    .subtitle-svg-container { position: relative; display: inline-block; margin-top: 0; }
    .subtitle { margin: 0; font-size: 1.1em; font-weight: 500; color: var(--text-primary); background-color: var(--surface-color); padding: 8px 16px; display: inline-block; position: relative; z-index: 2; white-space: nowrap; border-radius: var(--radius-md); font-family: 'Noto Sans Telugu', sans-serif; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all 0.2s; }
    .subtitle:focus { outline: 2px solid var(--accent-color); background-color: #f0f8ff; }
    .svg-divider { width: 400px; height: 5px; display: block; position: absolute; left: 50%; transform: translateX(-50%); top: 50%; margin-top: -2.5px; z-index: 1; }
    .schedule-table { width: 100%; border-collapse: collapse; font-size: 0.9em; border: 2px solid var(--border-color); font-family: 'Noto Sans Telugu', sans-serif; border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-sm); }
    .schedule-table th, .schedule-table td { border: 1px solid var(--border-color); padding: 12px 8px; text-align: center; vertical-align: middle; font-weight: 500; font-family: 'Noto Sans Telugu', sans-serif; }
    .schedule-table tbody td:not(:first-child):not(.special-event) { text-align: left; padding-left: 12px; }
    .schedule-table thead th { background-color: #f8f9fa; font-size: 1.0em; padding: 14px 8px; font-family: 'Noto Sans Telugu', sans-serif; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); }
    .schedule-table tbody tr:hover { background-color: #f8f9fa; }
    .schedule-table [contenteditable="true"]:focus { background-color: #fffbe5; outline: 2px solid var(--warning-color); border-radius: 4px; }
    .special-event { color: var(--danger-color); font-weight: 700; text-align: center; padding-left: 5px; font-family: 'Noto Sans Telugu', sans-serif; background-color: #fff5f5; }
    .event-btn { background: none; border: none; cursor: pointer; padding: 6px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; transition: background-color 0.2s; color: var(--text-secondary); }
    .event-btn:hover { background-color: #f0f0f0; color: var(--text-primary); }
    .desktop-dropdown { position: absolute; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-radius: 14px; border: 1px solid var(--border-color); box-shadow: 0 10px 35px rgba(0, 0, 0, 0.12); z-index: 1001; padding: 0; width: 340px; transform: scale(0.98) translateY(-10px); transform-origin: top; opacity: 0; visibility: hidden; transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1); overflow: hidden; display: block; }
    .desktop-dropdown.active { opacity: 1; visibility: visible; transform: scale(1) translateY(0); }
    .desktop-dropdown-search { display: flex; align-items: center; padding: 10px 14px; border-bottom: 1px solid var(--border-color); background: rgba(255,255,255,0.7); }
    .desktop-dropdown-search svg { margin-right: 8px; }
    .desktop-dropdown-search input { width: 100%; border: none; outline: none; background: transparent; font-size: 14px; color: var(--text-primary); }
    .desktop-dropdown-list { max-height: 260px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--accent-color) transparent; }
    .desktop-dropdown-list::-webkit-scrollbar { width: 6px; }
    .desktop-dropdown-list::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 3px; }
    .desktop-dropdown-item { display: flex; align-items: center; width: 100%; padding: 12px 16px; border: none; background: none; cursor: pointer; transition: background-color 0.2s; font-family: 'Noto Sans Telugu', sans-serif; font-size: 14px; text-align: left; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .desktop-dropdown-item:hover { background: rgba(0,123,255,0.08); color: var(--accent-color); }
    .desktop-dropdown-item.active { background: rgba(0,123,255,0.15); color: var(--accent-color); font-weight: 500; }
    .servant-tag { font-size: 0.75rem; font-weight: 600; color: var(--primary-color); background-color: var(--primary-light); padding: 4px 8px; border-radius: 12px; margin-left: auto; margin-right: 8px; }
    .desktop-event-menu { position: fixed; display: none; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 1001; padding: 8px; min-width: 180px; border: 1px solid var(--border-color); }
    .desktop-event-item { display: flex; align-items: center; width: 100%; padding: 10px 12px; border: none; background: none; cursor: pointer; transition: background-color 0.2s; font-family: 'Inter', sans-serif; font-size: 0.9rem; text-align: left; color: var(--text-primary); border-radius: 4px; }
    .desktop-event-item:hover { background-color: #f8fafc; }
    .editable-cell { cursor: pointer; transition: all 0.2s ease; position: relative; border-radius: 4px; }
    .editable-cell:hover { background-color: #f0f8ff; box-shadow: inset 0 0 0 1px var(--accent-color); }
    .editable-cell:after { content: ""; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.5; transition: opacity 0.2s; width: 16px; height: 16px; background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9L12 15L18 9' stroke='%23002726' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C/path%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; }
    .editable-cell:hover:after { opacity: 1; }
    .special-event { cursor: default !important; }
    .special-event:after { display: none; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 16px; backdrop-filter: blur(4px); }
    .modal-content { background: white; padding: 24px; border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; gap: 16px; box-shadow: var(--shadow-lg); transform: scale(0.9); opacity: 0; transition: all 0.3s ease; }
    .modal-overlay.active { display: flex; }
    .modal-overlay.active .modal-content { transform: scale(1); opacity: 1; }
    #new-schedule-name { width: 100%; padding: 12px 16px; font-size: 16px; border-radius: var(--radius-md); border: 2px solid var(--border-color); font-family: 'Inter', sans-serif; transition: border-color 0.2s; }
    #new-schedule-name:focus { outline: none; border-color: var(--accent-color); }
    #date-checklist { list-style: none; padding: 0; margin: 0; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md); max-height: 40vh; }
    #date-checklist label { display: flex; align-items: center; gap: 10px; font-size: 16px; cursor: pointer; font-weight: 500; padding: 12px 16px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
    #date-checklist label:last-child { border-bottom: none; }
    #date-checklist label:hover { background-color: #f8fafc; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px; }
    .modal-actions button { font-family: 'Inter', sans-serif; padding: 10px 20px; border-radius: var(--radius-md); font-size: 15px; font-weight: 600; cursor: pointer; border: 2px solid var(--border-color); transition: all 0.2s ease; }
    #cancel-creation { background-color: var(--surface-color); }
    #cancel-creation:hover { border-color: var(--text-secondary); }
    #confirm-creation { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    #confirm-creation:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    .dropdown-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; opacity: 0; visibility: hidden; transition: all 0.3s ease; backdrop-filter: blur(4px); }
    .dropdown-backdrop.active { opacity: 1; visibility: visible; }
    .dropdown-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; z-index: 1101; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 -10px 30px rgba(0,0,0,0.2); }
    .dropdown-container.active { transform: translateY(0); }
    .dropdown-header { padding: 20px 24px 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .dropdown-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); font-family: 'Noto Sans Telugu', sans-serif; }
    .dropdown-close { background: none; border: none; padding: 8px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: background-color 0.2s; }
    .dropdown-close:hover { background-color: #f5f5f5; }
    .mobile-dropdown-search { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-color); background: rgba(255,255,255,0.7); }
    .mobile-dropdown-search svg { margin-right: 8px; }
    .mobile-dropdown-search input { width: 100%; border: none; outline: none; background: transparent; font-size: 16px; color: var(--text-primary); }
    .dropdown-content { flex: 1; overflow-y: auto; padding: 8px 0; max-height: 300px; }
    .dropdown-item { display: flex; align-items: center; width: 100%; padding: 16px 24px; border: none; background: none; cursor: pointer; transition: background-color 0.2s; font-family: 'Noto Sans Telugu', sans-serif; font-size: 1rem; text-align: left; color: var(--text-primary); }
    .dropdown-item:hover { background-color: #f8fafc; }
    .dropdown-item.active { background-color: var(--primary-light); color: var(--primary-color); font-weight: 600; }
    .mobile-view-container { display: none; }
    .special-event-mobile { text-align: center; padding: 20px; background: linear-gradient(135deg, #fff5f5, #fed7d7); border-radius: var(--radius-lg); border: 2px dashed #fed7d7; margin: 16px 0; }
    .special-event-text-mobile { color: var(--danger-color); font-weight: 700; font-size: 1.1rem; margin: 0; font-family: 'Noto Sans Telugu', sans-serif; }
    #toggle-all-mobile { display: none; }

    @media (max-width: 768px) {
        .top-bar { padding: 0 16px; height: 56px; }
        .top-bar .mobileLogo { height: 56px; }
        .header-icons { height: 56px; }
        .menu-overlay { top: 56px; height: calc(100% - 56px); }
        .slide-menu { top: 56px; height: calc(100dvh - 56px); }
        main { padding-top: 56px; }
        .editor-main { padding: 0; }
        .page-controls { padding: 12px 16px; margin-bottom: 0; display: flex; justify-content: center; position: sticky; top: 56px; background-color: var(--surface-color); z-index: 800; border-bottom: 1px solid var(--border-color); }
        .master-container { padding: 0; border-radius: 0; box-shadow: none; background: transparent; border: none; }
        .schedule-table { display: none; }
        .mobile-view-container { display: flex; flex-direction: column; gap: 1rem; padding: 16px; }
        #toggle-all-mobile { display: inline-flex; margin: 0 auto 16px; background: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .title-block { padding: 16px; margin-bottom: 0; }
        .title-block h1 { font-size: 1.5rem; }
        .subtitle { font-size: 1rem; padding: 6px 12px; }
        .svg-divider { width: 300px; }
        .desktop-dropdown, .desktop-event-menu { display: none !important; }
        .mobile-week-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius-lg); margin-bottom: 0; box-shadow: var(--shadow-sm); transition: all 0.3s ease; overflow: hidden; }
        .mobile-week-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 20px; }
        .week-date { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin: 0; font-family: 'Noto Sans Telugu', sans-serif; text-align: left; }
        .accordion-icon { color: var(--text-secondary); transition: transform 0.3s ease; }
        .mobile-week-card.active .accordion-icon { transform: rotate(180deg); }
        .mobile-week-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; padding: 0 20px; }
        .mobile-week-card.active .mobile-week-body { max-height: 2000px; padding: 0 20px 20px 20px; border-top: 1px solid var(--border-color); margin-top: -1px; }
        .week-fields { display: flex; flex-direction: column; gap: 16px; padding-top: 20px; }
        .field-group { display: flex; flex-direction: column; gap: 8px; }
        .field-group label { font-size: 0.95rem; font-weight: 600; color: var(--text-secondary); font-family: 'Noto Sans Telugu', sans-serif; display: flex; align-items: center; gap: 6px; }
        .field-group label::before { content: ''; width: 4px; height: 16px; background: var(--primary-color); border-radius: 2px; }
        .mobile-field { padding: 16px; border: 2px solid var(--border-color); border-radius: var(--radius-md); background-color: #fafafa; cursor: pointer; font-family: 'Noto Sans Telugu', sans-serif; font-weight: 500; position: relative; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; min-height: 56px; }
        .mobile-field:hover { border-color: var(--accent-color); background-color: white; }
        .mobile-field::after { content: ""; width: 16px; height: 16px; background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9L12 15L18 9' stroke='%23002726' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C/path%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; transition: transform 0.2s ease; }
        .mobile-field.active::after { transform: rotate(180deg); }
        .mobile-field-value { flex: 1; color: var(--text-primary); }
        .mobile-field-placeholder { color: var(--text-secondary); font-style: italic; }
        .event-type-dropdown { margin-bottom: 20px; }
        .event-type-field { padding: 16px; border: 2px solid var(--border-color); border-radius: var(--radius-md); background-color: #fafafa; cursor: pointer; font-family: 'Noto Sans Telugu', sans-serif; font-weight: 500; position: relative; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; min-height: 56px; }
        .event-type-field:hover { border-color: var(--accent-color); background-color: white; }
        .event-type-field::after { content: ""; width: 16px; height: 16px; background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9L12 15L18 9' stroke='%23002726' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C/path%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; transition: transform 0.2s ease; }
        .event-type-field.active::after { transform: rotate(180deg); }
        .event-type-value { flex: 1; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .event-type-icon { font-size: 1.2rem; }
    }

    .pdf-page-container { background: white; padding: 20px; font-family: 'Noto Sans Telugu', sans-serif; width: 1100px; margin-bottom: 20px; }
    .pdf-table { width: 100%; border-collapse: collapse; font-family: 'Noto Sans Telugu', sans-serif; border: 2px solid #000; table-layout: fixed !important; }
    .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 8px 6px; font-family: 'Noto Sans Telugu', sans-serif; font-weight: 700; height: 35px; vertical-align: middle; box-sizing: border-box; overflow: hidden !important; text-overflow: ellipsis !important; white-space: nowrap !important; }
    .pdf-table thead th { background-color: #F3E5D7; font-size: 1.0em; padding: 8px 6px; }
    .pdf-header { text-align: center; margin-bottom: 20px; }
    .pdf-header .title-block { text-align: center; margin-bottom: 20px; }
    .pdf-header .subtitle-svg-container { position: relative; display: inline-block; margin-top: 10px; }
    .pdf-header .svg-divider { width: 400px; height: 5px; background: linear-gradient(to right, #ffffff, #093261, #ffffff); display: block; position: absolute; left: 50%; transform: translateX(-50%); top: 50%; margin-top: -2.5px; z-index: 1; }
</style>
</head>
<body>

<header class="site-header">
    <div class="top-bar">
        <a href="./sunday-dashboard.html" class="mobileLogo" title="Sunday Schedules"></a>
        <div class="header-right-controls">
            <div class="status-indicator" data-status="synced">Synced</div>
            <div class="header-icons">
                 <label class="hamburger">
                  <input type="checkbox" id="menu-checkbox">
                  <svg viewBox="0 0 32 32">
                    <path class="line line-top-bottom" d="M27 10 13 10C10.8 10 9 8.2 9 6 9 3.5 10.8 2 13 2 15.2 2 17 3.8 17 6L17 26C17 28.2 18.8 30 21 30 23.2 30 25 28.2 25 26 25 23.8 23.2 22 21 22L7 22"></path>
                    <path class="line" d="M7 16 27 16"></path>
                  </svg>
                </label>
            </div>
        </div>
    </div>
</header>

<div class="menu-overlay" id="menu-overlay"></div>
<div class="slide-menu" id="slide-menu">
    <ul class="menu-links">
        <li><a href="./home.html"><span class="iconLink-icon home-icon"></span><span>Home</span></a></li>
        <li><a href="./mid-week.html"><span class="iconLink-icon midweek-icon"></span><span>Mid-Week Schedules</span></a></li>
        <li><a href="./sunday-dashboard.html"><span class="iconLink-icon sunday-icon"></span><span>Sunday Schedules</span></a></li>
        <li><a href="./members.html"><span class="iconLink-icon members-icon"></span><span>Members</span></a></li>
    </ul>
    <div class="profile-section">
        <div class="profile-info">
            <div class="profile-name">Loading...</div>
        </div>
    </div>
</div>

<div id="app-container" class="editor-main hidden">
    <div class="page-controls">
        <button id="edit-weeks-button" class="btn">
            <span class="material-symbols-outlined">edit_calendar</span>
            <span>Edit Weeks</span>
        </button>
        <button id="print-button" class="btn">
            <span class="material-symbols-outlined">picture_as_pdf</span>
            <span>Download PDF</span>
        </button>
    </div>
    <div class="master-container">
        <div id="schedule-content-wrapper"></div>
    </div>
</div>

<div class="desktop-dropdown" id="desktop-dropdown">
    <div class="desktop-dropdown-search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="desktop-dropdown-search" placeholder="Search...">
    </div>
    <div class="desktop-dropdown-list" id="desktop-dropdown-list"></div>
</div>

<div class="desktop-event-menu" id="desktop-event-menu">
    <button class="desktop-event-item" data-event-type="normal">Normal</button>
    <button class="desktop-event-item" data-event-type="co-visit">CO Visit</button>
    <button class="desktop-event-item" data-event-type="assembly">Assembly</button>
    <button class="desktop-event-item" data-event-type="convention">Convention</button>
</div>

<div class="dropdown-backdrop" id="dropdown-backdrop"></div>
<div class="dropdown-container" id="dropdown-container">
    <div class="dropdown-header">
        <h3 class="dropdown-title" id="dropdown-title">Select Option</h3>
        <button class="dropdown-close" id="dropdown-close">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>
    <div class="mobile-dropdown-search" id="mobile-dropdown-search" style="display: none;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="mobile-search-input" placeholder="Search...">
    </div>
    <div class="dropdown-content" id="dropdown-content"></div>
</div>

<div id="date-selection-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Create New Sunday Schedule</h2>
        <p>Give your new schedule a name and select the weeks to include.</p>
        <input type="text" id="new-schedule-name" placeholder="E.g., Nov & Dec 2025 Schedule">
        <ul id="date-checklist"></ul>
        <div class="modal-actions">
            <button id="cancel-creation">Cancel</button>
            <button id="confirm-creation">Create Schedule</button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    const firebaseConfig = {
      apiKey: "AIzaSyDLK5f4C-nfG6fz0ajqqay1q9TTN6rxgmQ",
      authDomain: "schedule-harsha.firebaseapp.com",
      projectId: "schedule-harsha",
      storageBucket: "schedule-harsha.firebasestorage.app",
      messagingSenderId: "965478014820",
      appId: "1:965478014820:web:1c36c5d890a27e599aa471"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let currentScheduleId = null;
    let userSchedulesCollection = null;
    let membersCollection = null;
    let currentListener = null;
    let activeRowForEvents = null;
    let members = { brothers: [], sisters: [] };
    let activeCellForDropdown = null;
    let currentDropdownType = null;
    let currentDropdownData = null;
    let desktopDropdownSearch = null;
    let desktopDropdownList = null;
    let mobileSearchInput = null;

    const scheduleWrapper = document.getElementById('schedule-content-wrapper');
    const dateSelectionModal = document.getElementById('date-selection-modal');
    const statusIndicator = document.querySelector('.status-indicator');
    const desktopDropdown = document.getElementById('desktop-dropdown');
    const desktopEventMenu = document.getElementById('desktop-event-menu');
    const dropdownBackdrop = document.getElementById('dropdown-backdrop');
    const dropdownContainer = document.getElementById('dropdown-container');
    const dropdownTitle = document.getElementById('dropdown-title');
    const dropdownContent = document.getElementById('dropdown-content');
    const dropdownClose = document.getElementById('dropdown-close');
    const mobileDropdownSearch = document.getElementById('mobile-dropdown-search');

    const topics = {
        'అంశం-1': 'this is talk-1', 'అంశం-2': 'this is talk-2', 
        'అంశం-3': 'this is talk-3', 'అంశం-4': 'this is talk-4'
    };
    const eventTexts = {
        'co-visit': 'ప్రాంతీయ పర్యవేక్షకుని సందర్శన వారం',
        'assembly': 'ప్రాంతీయ సమావేశ కార్యక్రమం, బ్రాంచి ప్రతినిధితో',
        'convention': 'ప్రాదేశిక సమావేశం'
    };
    const eventTypes = [
        { id: 'normal', name: 'Normal', icon: 'event' },
        { id: 'co-visit', name: 'CO Visit', icon: 'groups' },
        { id: 'assembly', name: 'Assembly', icon: 'celebration' },
        { id: 'convention', name: 'Convention', icon: 'festival' }
    ];

    const debounce = (func, delay) => {
        let timeout;
        return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
    };

    function updateStatus(text, status) {
        statusIndicator.textContent = text;
        statusIndicator.dataset.status = status;
    }

    async function fetchMembers() {
        if (!currentUser) return;
        membersCollection = db.collection(`users/${currentUser.uid}/members`);
        const snapshot = await membersCollection.orderBy("name").get();
        members = { brothers: [], sisters: [] };
        snapshot.forEach(doc => {
            const member = { id: doc.id, ...doc.data() };
            if (member.type === 'brother') members.brothers.push(member);
        });
    }

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            await fetchMembers();
            userSchedulesCollection = db.collection(`userSundaySchedules/${currentUser.uid}/schedules`);
            document.body.classList.add('auth-ready');
            const profileNameEl = document.querySelector('.profile-name');
            if (profileNameEl) profileNameEl.textContent = user.email;
            
            setupGlobalUI();

            const params = new URLSearchParams(window.location.search);
            currentScheduleId = params.get('id');
            if (currentScheduleId) initEditor(); else initCreationFlow();
        } else {
            window.location.replace('./login.html');
        }
    });

    function initEditor() {
        if (currentListener) currentListener();
        userSchedulesCollection.doc(currentScheduleId).get().then(doc => {
            if (doc.exists) {
                renderSchedule(doc.data());
                updateStatus('Synced', 'synced');
            } else {
                alert("This schedule may have been deleted.");
                window.location.href = './sunday-dashboard.html';
            }
        }).catch(error => updateStatus('Error', 'error'));
        
        currentListener = userSchedulesCollection.doc(currentScheduleId).onSnapshot(doc => {
            if (doc.exists) updateStatus('Synced', 'synced');
        }, error => updateStatus('Error', 'error'));
    }

    function renderSchedule(data) {
        document.title = data.name;
        scheduleWrapper.innerHTML = `
            <header class="schedule-display-header"><div class="title-block"><h1>బహిరంగ ప్రసంగాల పట్టిక</h1><div class="subtitle-svg-container"><p class="subtitle" contenteditable="true">${data.dateRange || ''}</p><svg class="svg-divider" role="presentation" viewBox="0 0 24039.797 260" preserveAspectRatio="xMidYMid slice"><defs><radialGradient id="__id9__id4" gradientUnits="userSpaceOnUse" r="12020.601" cx="12019.898" cy="130" fx="12019.898" fy="130"><stop stop-color="#093261" stop-opacity="1" offset="0"></stop><stop stop-color="#ffffff" stop-opacity="1" offset="1"></stop></radialGradient></defs><rect x="0" y="0" width="24039.797" height="260" fill="url(#__id9__id4)"></rect></svg></div></div></header>
            <main><button id="toggle-all-mobile" class="btn"><span class="material-symbols-outlined">unfold_more</span><span>Open All</span></button><div class="mobile-view-container"></div><table class="schedule-table"><thead><tr><th>తేదీ</th><th>ప్రసంగ అంశం</th><th>ప్రసంగీకుడు</th><th>చైర్మన్</th><th>కావలికోట రీడర్</th><th class="actions-col">Actions</th></tr></thead><tbody>${data.tableHTML}</tbody></table></main>`;
        
        scheduleWrapper.querySelectorAll('tbody td').forEach((cell) => {
            const cellIndex = cell.cellIndex;
            if (cellIndex === 0 || cellIndex === 5) return;
            cell.classList.add('editable-cell');
            cell.removeAttribute('contenteditable');
            cell.addEventListener('click', () => {
                if (cellIndex === 1) openDesktopDropdown('topic', cell);
                else openDesktopDropdown('member', cell);
            });
        });
        
        createMobileView();
        scheduleWrapper.addEventListener('input', debouncedSave);
        scheduleWrapper.querySelectorAll('.event-btn').forEach(btn => btn.addEventListener('click', openEventMenu));
        document.getElementById('app-container').classList.remove('hidden');
    }

    function createMobileView() {
        const mobileContainer = scheduleWrapper.querySelector('.mobile-view-container');
        const tableBody = scheduleWrapper.querySelector('.schedule-table tbody');
        if (!tableBody) return;
        mobileContainer.innerHTML = '';
        
        Array.from(tableBody.rows).forEach((row, rowIndex) => {
            const card = document.createElement('div');
            card.className = 'mobile-week-card';
            card.dataset.rowIndex = rowIndex;
            card.innerHTML = `<div class="mobile-week-header"><h3 class="week-date">${row.cells[0].textContent}</h3><span class="material-symbols-outlined accordion-icon">expand_more</span></div><div class="mobile-week-body"></div>`;
            const cardBody = card.querySelector('.mobile-week-body');
            cardBody.innerHTML = getMobileCardBodyHTML(row);
            mobileContainer.appendChild(card);
            setupMobileEventListeners(card);
        });
    }

    function getMobileCardBodyHTML(row) {
        const isSpecialEvent = row.cells[1].classList.contains('special-event');
        const currentEventType = getEventTypeForRow(row);
        const eventTypeDetails = eventTypes.find(e => e.id === currentEventType) || eventTypes[0];
        
        let bodyContent = `<div class="event-type-dropdown"><div class="event-type-field"><span class="event-type-value"><span class="material-symbols-outlined event-type-icon">${eventTypeDetails.icon}</span><span>${eventTypeDetails.name}</span></span></div></div>`;

        if (isSpecialEvent) {
            bodyContent += `<div class="special-event-mobile"><p class="special-event-text-mobile">${row.cells[1].textContent}</p></div>`;
        } else {
            const fields = [
                { label: 'ప్రసంగ అంశం', type: 'topic-field', cellIndex: 1, placeholder: 'Select Topic' },
                { label: 'ప్రసంగీకుడు', type: 'member-field', cellIndex: 2, placeholder: 'Select Brother' },
                { label: 'చైర్మన్', type: 'member-field', cellIndex: 3, placeholder: 'Select Brother' },
                { label: 'కావలికోట రీడర్', type: 'member-field', cellIndex: 4, placeholder: 'Select Brother' }
            ];
            let fieldsHTML = fields.map(field => {
                const cellText = row.cells[field.cellIndex].textContent.trim();
                return `<div class="field-group"><label>${field.label}</label><div class="mobile-field ${field.type}" data-cell="${field.cellIndex}"><span class="mobile-field-value ${cellText ? '' : 'mobile-field-placeholder'}">${cellText || field.placeholder}</span></div></div>`;
            }).join('');
            bodyContent += `<div class="week-fields">${fieldsHTML}</div>`;
        }
        return bodyContent;
    }

    function setupMobileEventListeners(card) {
        const rowIndex = card.dataset.rowIndex;
        card.querySelectorAll('.topic-field, .member-field').forEach(field => {
            field.addEventListener('click', () => {
                const cellIndex = field.dataset.cell;
                const cell = scheduleWrapper.querySelector(`tbody tr:nth-child(${parseInt(rowIndex) + 1}) td:nth-child(${parseInt(cellIndex) + 1})`);
                const type = field.classList.contains('topic-field') ? 'topic' : 'member';
                openMobileDropdown(type, cell, field);
            });
        });
        card.querySelector('.event-type-field').addEventListener('click', () => {
            openMobileEventTypeDropdown(rowIndex, card.querySelector('.event-type-field'));
        });
    }

    function getEventTypeForRow(row) {
        const topicCell = row.cells[1];
        if (topicCell.classList.contains('special-event')) {
            const text = topicCell.textContent;
            if (text.includes('పర్యవేక్షకుని')) return 'co-visit';
            if (text.includes('సమావేశ కార్యక్రమం')) return 'assembly';
            if (text.includes('సమావేశం')) return 'convention';
        }
        return 'normal';
    }

    function changeEventType(rowIndex, eventType) {
        const tableBody = scheduleWrapper.querySelector('.schedule-table tbody');
        const row = tableBody.rows[rowIndex];
        const [dateCell, topicCell, speakerCell, chairmanCell, readerCell] = row.cells;
        
        [topicCell, speakerCell, chairmanCell, readerCell].forEach(cell => {
            cell.style.display = '';
            cell.classList.add('editable-cell');
        });
        topicCell.colSpan = 1;
        topicCell.classList.remove('special-event');

        if (eventType !== 'normal') {
            ['originalTopic', 'originalSpeaker', 'originalChairman', 'originalReader'].forEach((key, i) => {
                if(row.cells[i+1].textContent) row.dataset[key] = row.cells[i+1].textContent;
            });
            topicCell.colSpan = 4;
            topicCell.classList.add('special-event');
            topicCell.classList.remove('editable-cell');
            topicCell.textContent = eventTexts[eventType];
            [speakerCell, chairmanCell, readerCell].forEach(cell => {
                cell.style.display = 'none';
                cell.classList.remove('editable-cell');
                cell.textContent = '';
            });
        } else {
            topicCell.textContent = row.dataset.originalTopic || '';
            speakerCell.textContent = row.dataset.originalSpeaker || '';
            chairmanCell.textContent = row.dataset.originalChairman || '';
            readerCell.textContent = row.dataset.originalReader || '';
            delete row.dataset.originalTopic;
            delete row.dataset.originalSpeaker;
            delete row.dataset.originalChairman;
            delete row.dataset.originalReader;
        }
        
        const cardBody = scheduleWrapper.querySelector(`.mobile-week-card[data-row-index="${rowIndex}"] .mobile-week-body`);
        if (cardBody) {
            cardBody.innerHTML = getMobileCardBodyHTML(row);
            setupMobileEventListeners(cardBody.closest('.mobile-week-card'));
        }
        debouncedSave();
    }

    function openDesktopDropdown(type, cell) {
        currentDropdownType = type;
        activeCellForDropdown = cell;
        if (type === 'member') showDesktopMemberDropdown(cell);
        else if (type === 'topic') showDesktopTopicDropdown(cell);
    }
    
    function showDesktopMemberDropdown(cell) {
        desktopDropdownList.innerHTML = '';
        const sortedBrothers = [...members.brothers].sort((a, b) => a.name.localeCompare(b.name));
        if (sortedBrothers.length === 0) {
            desktopDropdownList.innerHTML = '<div style="padding: 12px 16px; color: var(--text-secondary);">No brothers available</div>';
        } else {
            sortedBrothers.forEach(member => {
                const item = document.createElement('div');
                item.className = 'desktop-dropdown-item';
                item.innerHTML = `<span>${member.name}</span>${member.isServant ? '<span class="servant-tag">Servant</span>' : ''}`;
                item.addEventListener('click', () => selectDesktopDropdownItem(member.name));
                desktopDropdownList.appendChild(item);
            });
        }
        showDesktopDropdown(cell);
    }

    function showDesktopTopicDropdown(cell) {
        desktopDropdownList.innerHTML = '';
        Object.entries(topics).forEach(([topicName, topicText]) => {
            const item = document.createElement('div');
            item.className = 'desktop-dropdown-item';
            item.textContent = topicName;
            item.addEventListener('click', () => selectDesktopDropdownItem(topicText));
            desktopDropdownList.appendChild(item);
        });
        showDesktopDropdown(cell);
    }

    function showDesktopDropdown(cell) {
        const rect = cell.getBoundingClientRect();
        let top = rect.bottom + window.scrollY, left = rect.left + window.scrollX;
        desktopDropdown.style.display = 'block';
        desktopDropdown.style.top = `${top}px`;
        desktopDropdown.style.left = `${left}px`;
        desktopDropdown.style.width = `${rect.width}px`;
        desktopDropdownSearch.value = '';
        filterDesktopItems('');
        setTimeout(() => {
            desktopDropdown.classList.add('active');
            desktopDropdownSearch.focus();
        }, 10);
    }

    function hideDesktopDropdown() {
        desktopDropdown.classList.remove('active');
        setTimeout(() => { desktopDropdown.style.display = 'none'; }, 250);
        activeCellForDropdown = null;
    }

    function selectDesktopDropdownItem(value) {
        if (activeCellForDropdown) {
            activeCellForDropdown.textContent = value;
            updateCorrespondingMobileField(activeCellForDropdown, value);
            debouncedSave();
        }
        hideDesktopDropdown();
    }

    function updateCorrespondingMobileField(cell, value) {
        const rowIndex = Array.from(cell.parentElement.parentElement.children).indexOf(cell.parentElement);
        const cellIndex = Array.from(cell.parentElement.cells).indexOf(cell);
        const mobileCard = scheduleWrapper.querySelector(`.mobile-week-card[data-row-index="${rowIndex}"]`);
        if (mobileCard) {
            const field = mobileCard.querySelector(`.mobile-field[data-cell="${cellIndex}"]`);
            if (field) {
                const valueSpan = field.querySelector('.mobile-field-value');
                valueSpan.textContent = value;
                valueSpan.classList.remove('mobile-field-placeholder');
            }
        }
    }

    function filterDesktopItems(value) {
        desktopDropdownList.querySelectorAll('.desktop-dropdown-item').forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(value.toLowerCase()) ? 'flex' : 'none';
        });
    }

    function openEventMenu(e) {
        activeRowForEvents = e.currentTarget.closest('tr');
        const rect = e.currentTarget.getBoundingClientRect();
        desktopEventMenu.style.display = 'block';
        desktopEventMenu.style.top = `${rect.bottom}px`;
        desktopEventMenu.style.left = `${rect.left - desktopEventMenu.offsetWidth + rect.width}px`;
    }

    function hideDesktopEventMenu() {
        desktopEventMenu.style.display = 'none';
        activeRowForEvents = null;
    }

    function applyEventType(eventType) {
        if (!activeRowForEvents) return;
        const rowIndex = Array.from(activeRowForEvents.parentElement.children).indexOf(activeRowForEvents);
        changeEventType(rowIndex, eventType);
        hideDesktopEventMenu();
    }

    function openMobileDropdown(type, cell, fieldElement) {
        currentDropdownData = { cell, fieldElement };
        fieldElement.classList.add('active');
        if (type === 'member') showMobileMemberDropdown();
        else if (type === 'topic') showMobileTopicDropdown();
        mobileDropdownSearch.style.display = 'flex';
        document.body.classList.add('dropdown-open');
    }

    function openMobileEventTypeDropdown(rowIndex, fieldElement) {
        currentDropdownData = { rowIndex, fieldElement };
        fieldElement.classList.add('active');
        showMobileEventTypeDropdown();
        mobileDropdownSearch.style.display = 'none';
        document.body.classList.add('dropdown-open');
    }

    function showMobileMemberDropdown() {
        dropdownTitle.textContent = 'Select Brother';
        dropdownContent.innerHTML = '';
        const sortedBrothers = [...members.brothers].sort((a, b) => a.name.localeCompare(b.name));
        if (sortedBrothers.length === 0) {
            dropdownContent.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No brothers available</div>';
        } else {
            sortedBrothers.forEach(member => {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.innerHTML = `<span>${member.name}</span>${member.isServant ? '<span class="servant-tag">Servant</span>' : ''}`;
                item.addEventListener('click', () => selectMobileDropdownItem(member.name));
                dropdownContent.appendChild(item);
            });
        }
        showMobileDropdown();
    }

    function showMobileTopicDropdown() {
        dropdownTitle.textContent = 'Select Topic';
        dropdownContent.innerHTML = '';
        Object.entries(topics).forEach(([topicName, topicText]) => {
            const item = document.createElement('button');
            item.className = 'dropdown-item';
            item.textContent = topicName;
            item.addEventListener('click', () => selectMobileDropdownItem(topicText));
            dropdownContent.appendChild(item);
        });
        showMobileDropdown();
    }

    function showMobileEventTypeDropdown() {
        dropdownTitle.textContent = 'Select Event Type';
        dropdownContent.innerHTML = '';
        eventTypes.forEach(event => {
            const item = document.createElement('button');
            item.className = 'dropdown-item';
            item.innerHTML = `<span style="display: flex; align-items: center; gap: 12px;"><span class="material-symbols-outlined">${event.icon}</span><span>${event.name}</span></span>`;
            item.addEventListener('click', () => selectMobileEventType(event.id));
            dropdownContent.appendChild(item);
        });
        showMobileDropdown();
    }

    function showMobileDropdown() {
        dropdownBackdrop.classList.add('active');
        dropdownContainer.classList.add('active');
        mobileSearchInput.value = '';
        filterMobileItems('');
        setTimeout(() => { if (mobileDropdownSearch.style.display !== 'none') mobileSearchInput.focus(); }, 100);
    }

    function hideMobileDropdown() {
        dropdownBackdrop.classList.remove('active');
        dropdownContainer.classList.remove('active');
        if (currentDropdownData && currentDropdownData.fieldElement) currentDropdownData.fieldElement.classList.remove('active');
        document.body.classList.remove('dropdown-open');
        currentDropdownData = null;
    }

    function selectMobileDropdownItem(value) {
        if (currentDropdownData) {
            currentDropdownData.cell.textContent = value;
            if (currentDropdownData.fieldElement) {
                const valueSpan = currentDropdownData.fieldElement.querySelector('.mobile-field-value');
                valueSpan.textContent = value;
                valueSpan.classList.remove('mobile-field-placeholder');
            }
            debouncedSave();
        }
        hideMobileDropdown();
    }

    function selectMobileEventType(eventType) {
        if (currentDropdownData && currentDropdownData.rowIndex !== undefined) {
            changeEventType(currentDropdownData.rowIndex, eventType);
        }
        hideMobileDropdown();
    }

    function filterMobileItems(value) {
        dropdownContent.querySelectorAll('.dropdown-item').forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(value.toLowerCase()) ? 'flex' : 'none';
        });
    }

    function openWeekEditor() {
        const dateList = document.getElementById('date-checklist');
        const upcomingSundays = generateNextSundays(30);
        dateList.innerHTML = '';
        const currentDates = getCurrentScheduleDates();
        upcomingSundays.forEach(dateStr => {
            const li = document.createElement('li');
            li.innerHTML = `<label><input type="checkbox" value="${dateStr}" ${currentDates.includes(dateStr) ? 'checked' : ''}> ${dateStr}</label>`;
            dateList.appendChild(li);
        });
        document.querySelector('#date-selection-modal h2').textContent = 'Edit Sunday Schedule Weeks';
        document.querySelector('#date-selection-modal p').textContent = 'Add or remove weeks from your schedule.';
        document.getElementById('new-schedule-name').style.display = 'none';
        document.getElementById('confirm-creation').textContent = 'Update Schedule';
        dateSelectionModal.classList.add('active');
    }

    function getCurrentScheduleDates() {
        const dates = [];
        scheduleWrapper.querySelectorAll('tbody tr').forEach(row => {
            if (row.cells[0]) dates.push(row.cells[0].textContent.trim());
        });
        return dates;
    }

    function findExistingRowForDate(date) {
        for (let row of scheduleWrapper.querySelectorAll('tbody tr')) {
            if (row.cells[0].textContent.trim() === date) return row;
        }
        return null;
    }

    async function handleUpdateWeeks() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('#date-checklist input:checked'));
        if (selectedCheckboxes.length === 0) return alert("Please select at least one Sunday.");
        const selectedDates = selectedCheckboxes.map(cb => cb.value);
        const dateRange = `${selectedDates[0]} నుండి ${selectedDates[selectedDates.length - 1]}`;
        const tableBodyHTML = selectedDates.map(date => {
            const existingRow = findExistingRowForDate(date);
            if (existingRow) {
                return `<tr>${existingRow.innerHTML}</tr>`;
            } else {
                return `<tr><td>${date}</td><td class="editable-cell"></td><td class="editable-cell"></td><td class="editable-cell"></td><td class="editable-cell"></td><td class="actions-col"><button class="event-btn"><span class="material-symbols-outlined">more_vert</span></button></td></tr>`;
            }
        }).join('');
        try {
            updateStatus('Updating...', 'syncing');
            await userSchedulesCollection.doc(currentScheduleId).update({ dateRange, tableHTML, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            initEditor();
            dateSelectionModal.classList.remove('active');
            updateStatus('Synced', 'synced');
        } catch (error) {
            console.error("Error updating weeks:", error);
            alert("Could not update schedule.");
            updateStatus('Error', 'error');
        }
    }

    const debouncedSave = debounce(() => {
        const subtitleEl = scheduleWrapper.querySelector('.subtitle');
        const tableBodyEl = scheduleWrapper.querySelector('.schedule-table tbody');
        if (!subtitleEl || !tableBodyEl) return;
        updateStatus('Syncing...', 'syncing');
        const payload = { dateRange: subtitleEl.textContent, tableHTML: tableBodyEl.innerHTML };
        userSchedulesCollection.doc(currentScheduleId).update(payload)
            .then(() => updateStatus('Synced', 'synced'))
            .catch(err => { console.error("Save failed:", err); updateStatus('Error', 'error'); });
    }, 1500);

    function initCreationFlow() {
        const dateList = document.getElementById('date-checklist');
        dateList.innerHTML = generateNextSundays(30).map(dateStr => `<li><label><input type="checkbox" value="${dateStr}"> ${dateStr}</label></li>`).join('');
        dateSelectionModal.classList.add('active');
    }
    
    function generateNextSundays(count) {
        const sundays = [];
        let currentDate = new Date();
        currentDate.setDate(currentDate.getDate() + (7 - currentDate.getDay()) % 7);
        for (let i = 0; i < count; i++) {
            sundays.push(`${String(currentDate.getDate()).padStart(2, '0')}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${currentDate.getFullYear()}`);
            currentDate.setDate(currentDate.getDate() + 7);
        }
        return sundays;
    }

    async function handleCreateSchedule() {
        const scheduleName = document.getElementById('new-schedule-name').value.trim();
        if (!scheduleName) return alert("Please enter a name for the schedule.");
        const selectedCheckboxes = Array.from(document.querySelectorAll('#date-checklist input:checked'));
        if (selectedCheckboxes.length === 0) return alert("Please select at least one Sunday.");
        const selectedDates = selectedCheckboxes.map(cb => cb.value);
        const dateRange = `${selectedDates[0]} నుండి ${selectedDates[selectedDates.length - 1]}`;
        const tableBodyHTML = selectedDates.map(date => `<tr><td>${date}</td><td class="editable-cell"></td><td class="editable-cell"></td><td class="editable-cell"></td><td class="editable-cell"></td><td class="actions-col"><button class="event-btn"><span class="material-symbols-outlined">more_vert</span></button></td></tr>`).join('');
        try {
            const newDocRef = await userSchedulesCollection.add({ name: scheduleName, dateRange, tableHTML, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            window.location.href = `./sunday-editor.html?id=${newDocRef.id}`;
        } catch (error) {
            console.error("Error creating new schedule:", error);
            alert("Could not create schedule.");
        }
    }
    
    async function generatePdf() {
        const printButton = document.getElementById('print-button');
        printButton.disabled = true;
        printButton.querySelector('span:last-child').textContent = 'Generating...';
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'mm', 'a4');
        const A4_WIDTH_MM = 297, A4_HEIGHT_MM = 210;
        const MARGIN_X_MM = 15, MARGIN_Y_MM = 10;
        const USABLE_WIDTH = A4_WIDTH_MM - (MARGIN_X_MM * 2);
        const USABLE_HEIGHT = A4_HEIGHT_MM - (MARGIN_Y_MM * 2);
        try {
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            document.body.appendChild(tempContainer);
            const scheduleData = document.getElementById('schedule-content-wrapper');
            const title = scheduleData.querySelector('h1').textContent;
            const subtitle = scheduleData.querySelector('.subtitle').textContent;
            const tableRows = Array.from(scheduleData.querySelectorAll('tbody tr'));
            const rowsFirstPage = 15, rowsOtherPages = 17;
            let currentRow = 0, pageCount = 0;
            while (currentRow < tableRows.length) {
                if (pageCount > 0) pdf.addPage();
                const pageContainer = document.createElement('div');
                pageContainer.className = 'pdf-page-container';
                if (pageCount === 0) {
                    const header = document.createElement('div');
                    header.className = 'pdf-header';
                    header.innerHTML = `<div class="title-block" style="text-align: center; margin-bottom: 20px;"><h1 style="font-family: 'Noto Sans Telugu', sans-serif; font-weight: 700; color: rgb(97, 40, 0); margin: 0; font-size: 1.8em;">${title}</h1><div style="position: relative; display: inline-block; margin-top: 10px;"><p style="font-family: 'Noto Sans Telugu', sans-serif; font-weight: 500; color: #333; background-color: #ffffff; padding: 2px 8px; display: inline-block; position: relative; z-index: 2; white-space: nowrap; border-radius: 8px; margin: 0;">${subtitle}</p><div style="width: 400px; height: 5px; background: linear-gradient(to right, #093261, #ffffff, #093261); position: absolute; left: 50%; transform: translateX(-50%); top: 50%; margin-top: -2.5px; z-index: 1;"></div></div></div>`;
                    pageContainer.appendChild(header);
                }
                const table = document.createElement('table');
                table.className = 'pdf-table';
                table.style.tableLayout = 'fixed';
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th style="width: 15%">తేదీ</th><th style="width: 35%">ప్రసంగ అంశం</th><th style="width: 20%">ప్రసంగీకుడు</th><th style="width: 15%">చైర్మన్</th><th style="width: 15%">కావలికోట రీడర్</th></tr>`;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                const rowsThisPage = pageCount === 0 ? rowsFirstPage : rowsOtherPages;
                const endRow = Math.min(currentRow + rowsThisPage, tableRows.length);
                for (let i = currentRow; i < endRow; i++) {
                    const originalRow = tableRows[i];
                    const row = document.createElement('tr');
                    for (let j = 0; j < originalRow.cells.length - 1; j++) {
                        const cell = document.createElement(j === 0 ? 'th' : 'td');
                        cell.innerHTML = originalRow.cells[j].innerHTML;
                        if (originalRow.cells[1].classList.contains('special-event')) {
                            if (j === 1) { cell.className = 'special-event'; cell.colSpan = 4; cell.style.width = '85%'; j += 3; }
                        }
                        row.appendChild(cell);
                    }
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                pageContainer.appendChild(table);
                tempContainer.appendChild(pageContainer);
                await document.fonts.ready;
                await new Promise(resolve => setTimeout(resolve, 50));
                const canvas = await html2canvas(pageContainer, { scale: 1, useCORS: true, backgroundColor: '#ffffff', letterRendering: false, logging: false, imageTimeout: 15000, removeContainer: true });
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * USABLE_WIDTH) / imgProps.width;
                const verticalPosition = Math.max(0, (USABLE_HEIGHT - imgHeight) / 2);
                pdf.addImage(imgData, 'JPEG', MARGIN_X_MM, MARGIN_Y_MM + verticalPosition, USABLE_WIDTH, imgHeight, undefined, 'FAST');
                tempContainer.removeChild(pageContainer);
                currentRow = endRow;
                pageCount++;
            }
            document.body.removeChild(tempContainer);
            pdf.save(`${document.title || 'sunday-schedule'}.pdf`);
        } catch (error) {
            console.error("PDF generation failed:", error);
            alert("Sorry, there was an error creating the PDF. Please try again.");
        } finally {
            printButton.disabled = false;
            printButton.querySelector('span:last-child').textContent = 'Download PDF';
        }
    }

    function setupGlobalUI() {
        desktopDropdownSearch = document.getElementById('desktop-dropdown-search');
        desktopDropdownList = document.getElementById('desktop-dropdown-list');
        mobileSearchInput = document.getElementById('mobile-search-input');
        
        const menuCheckbox = document.getElementById('menu-checkbox');
        const slideMenu = document.getElementById('slide-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const body = document.body;
        
        function closeMenu() {
            slideMenu.classList.remove('is-open');
            menuOverlay.classList.remove('is-open');
            body.classList.remove('menu-open');
            menuCheckbox.checked = false;
        }
        
        menuCheckbox.addEventListener('change', () => {
            if(menuCheckbox.checked) {
                slideMenu.classList.add('is-open');
                menuOverlay.classList.add('is-open');
                body.classList.add('menu-open');
            } else {
                closeMenu();
            }
        });
        menuOverlay.addEventListener('click', closeMenu);

        document.getElementById('print-button').addEventListener('click', generatePdf);
        document.getElementById('edit-weeks-button').addEventListener('click', openWeekEditor);
        document.getElementById('cancel-creation').addEventListener('click', () => {
            dateSelectionModal.classList.remove('active');
            setTimeout(() => {
                dateSelectionModal.style.display = 'none';
                if (!currentScheduleId) window.location.href = './sunday-dashboard.html';
            }, 300);
        });
        document.getElementById('confirm-creation').addEventListener('click', function() {
            if (this.textContent === 'Create Schedule') handleCreateSchedule();
            else handleUpdateWeeks();
        });

        dropdownBackdrop.addEventListener('click', hideMobileDropdown);
        dropdownClose.addEventListener('click', hideMobileDropdown);
        desktopDropdownSearch.addEventListener('input', (e) => filterDesktopItems(e.target.value));
        mobileSearchInput.addEventListener('input', (e) => filterMobileItems(e.target.value));
        document.addEventListener('click', (e) => {
            if (!desktopDropdown.contains(e.target) && !e.target.closest('.editable-cell')) hideDesktopDropdown();
            if (!desktopEventMenu.contains(e.target) && !e.target.closest('.event-btn')) hideDesktopEventMenu();
        });
        desktopEventMenu.addEventListener('click', (e) => {
            const target = e.target.closest('.desktop-event-item');
            if (target) applyEventType(target.dataset.eventType);
        });
        dropdownContainer.addEventListener('click', (e) => e.stopPropagation());
        
        scheduleWrapper.addEventListener('click', e => {
            const header = e.target.closest('.mobile-week-header');
            if (header) {
                const currentCard = header.closest('.mobile-week-card');
                if (!currentCard) return;
                const isAlreadyOpen = currentCard.classList.contains('active');
                document.querySelectorAll('.mobile-view-container .mobile-week-card').forEach(card => card.classList.remove('active'));
                if (!isAlreadyOpen) currentCard.classList.add('active');
            }
        });
        const toggleAllBtn = scheduleWrapper.querySelector('#toggle-all-mobile');
        if(toggleAllBtn) {
            toggleAllBtn.addEventListener('click', () => {
                const allCards = scheduleWrapper.querySelectorAll('.mobile-view-container .mobile-week-card');
                const areAnyOpen = Array.from(allCards).some(card => card.classList.contains('active'));
                const textSpan = toggleAllBtn.querySelector('span:last-child');
                const iconSpan = toggleAllBtn.querySelector('.material-symbols-outlined');
                if (areAnyOpen) {
                    allCards.forEach(card => card.classList.remove('active'));
                    textSpan.textContent = 'Open All';
                    iconSpan.textContent = 'unfold_more';
                } else {
                    allCards.forEach(card => card.classList.add('active'));
                    textSpan.textContent = 'Close All';
                    iconSpan.textContent = 'unfold_less';
                }
            });
        }
        
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.style.display = 'none', 300);
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (dropdownContainer.classList.contains('active')) hideMobileDropdown();
                if (desktopDropdown.classList.contains('active')) hideDesktopDropdown();
                if (desktopEventMenu.style.display === 'block') hideDesktopEventMenu();
                if (dateSelectionModal.classList.contains('active')) {
                    dateSelectionModal.classList.remove('active');
                    setTimeout(() => dateSelectionModal.style.display = 'none', 300);
                }
            }
        });
    }
})();
</script>
</body>
</html>
